<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Premium Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS (SAME AS BEFORE - NO CHANGES NEEDED) -->
    <style>
        :root { --primary: #6366f1; --bg: #f3f4f6; --surface: #ffffff; --text: #111827; --text-light: #6b7280; --danger: #ef4444; --success: #10b981; --warning: #f59e0b; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--text); display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--surface); height: 100vh; position: fixed; left: 0; top: 0; border-right: 1px solid #e5e7eb; z-index: 1000; transition: transform 0.3s; }
        .brand { padding: 20px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 10px; font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        .menu { padding: 15px 0; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px 25px; color: var(--text-light); text-decoration: none; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: #eef2ff; color: var(--primary); border-right: 3px solid var(--primary); }
        .main-content { margin-left: 260px; width: calc(100% - 260px); padding: 30px; transition: margin 0.3s, width 0.3s; }
        .mob-header { display: none; justify-content: space-between; align-items: center; background: var(--surface); padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--surface); padding: 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f3f4f6; }
        .card-title { font-size: 1.1rem; font-weight: 600; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-item { background: var(--surface); padding: 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-item h3 { font-size: 0.9rem; color: var(--text-light); text-transform: uppercase; margin-bottom: 5px; }
        .stat-item h1 { font-size: 2rem; font-weight: 700; color: var(--text); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { text-align: left; padding: 15px; background: #f9fafb; color: var(--text-light); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f3f4f6; font-size: 0.95rem; vertical-align: middle; }
        .user-cell { display: flex; align-items: center; gap: 10px; }
        .user-img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid #e5e7eb; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; color: var(--text-light); }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; transition: 0.2s; background: #fff; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: 0.2s; font-size: 0.9rem; color: white; }
        .btn-p { background: var(--primary); } .btn-s { background: var(--success); } .btn-d { background: var(--danger); } .btn-w { background: var(--warning); }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; margin-right: 5px; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 900; display: none; }
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .sidebar.show { transform: translateX(0); } .main-content { margin-left: 0; width: 100%; } .mob-header { display: flex; } .overlay.show { display: block; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="overlay" onclick="toggleMenu()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="brand"><i class="fas fa-shield-alt"></i> Admin Pro</div>
        <div class="menu">
            <div class="menu-item active" onclick="nav('dashboard', this)"><i class="fas fa-home"></i> Dashboard</div>
            <div class="menu-item" onclick="nav('users', this)"><i class="fas fa-users"></i> Users</div>
            <div class="menu-item" onclick="nav('tasks', this)"><i class="fas fa-tasks"></i> Tasks</div>
            <div class="menu-item" onclick="nav('ads', this)"><i class="fas fa-ad"></i> Ads</div>
            <div class="menu-item" onclick="nav('withdraw', this)"><i class="fas fa-wallet"></i> Withdrawals</div>
            <div class="menu-item" onclick="nav('settings', this)"><i class="fas fa-cog"></i> Settings</div>
        </div>
    </aside>

    <main class="main-content">
        <div class="mob-header"><h3>Admin Panel</h3><i class="fas fa-bars" style="font-size: 1.5rem; cursor: pointer;" onclick="toggleMenu()"></i></div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="page active">
            <div class="stats">
                <div class="stat-item"><h3>Total Users</h3><h1 id="stat-users">0</h1></div>
                <div class="stat-item"><h3>Pending Requests</h3><h1 id="stat-pending" style="color:var(--warning)">0</h1></div>
                <div class="stat-item"><h3>Total Paid</h3><h1 id="stat-paid" style="color:var(--success)">0</h1></div>
            </div>
        </div>

        <!-- USERS -->
        <div id="users" class="page">
            <div class="card">
                <div class="card-head"><span class="card-title">User List</span><input type="text" id="search-box" placeholder="Search..." style="width: 200px;" onkeyup="filterUsers()"></div>
                <div class="table-container"><table id="user-table"><thead><tr><th>User</th><th>Balance</th><th>Referrals</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td colspan="5" style="text-align:center;">Loading...</td></tr></tbody></table></div>
            </div>
        </div>

        <!-- TASKS -->
        <div id="tasks" class="page">
            <div class="card">
                <div class="card-head"><span class="card-title" id="task-card-title">Add New Task</span></div>
                <input type="hidden" id="edit-key">
                <div class="form-row">
                    <div class="form-group"><label>Task Name</label><input id="t-name" placeholder="e.g. Join Channel"></div>
                    <div class="form-group"><label>Reward</label><input id="t-reward" type="number" placeholder="1.00"></div>
                </div>
                <div class="form-group"><label>Task Link</label><input id="t-url" placeholder="https://..."></div>
                <div class="form-group"><label>Icon URL</label><input id="t-icon" placeholder="https://..."></div>
                <div class="form-group"><label>Task Type</label><select id="t-type"><option value="onetime">One Time</option><option value="daily">Daily</option></select></div>
                <div style="margin-top: 15px;"><button id="btn-save-task" class="btn btn-s" onclick="saveTask()">Add Task</button><button id="btn-cancel-task" class="btn btn-d" onclick="cancelEdit()" style="display:none;">Cancel</button></div>
            </div>
            <div class="card">
                <div class="card-head"><span class="card-title">Active Tasks</span></div>
                <div class="table-container"><table id="task-table"><thead><tr><th>Icon</th><th>Name</th><th>Reward</th><th>Type</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <!-- ADS -->
        <div id="ads" class="page">
            <div class="card">
                <div class="card-head"><span class="card-title">Ad Configuration</span></div>
                <div class="form-group" style="background:#f9fafb; padding:15px; border-radius:8px;"><label style="color:var(--primary); margin-bottom:10px;">Ad Slot 1</label><div class="form-row"><select id="s1-net"><option value="monetag">Monetag</option><option value="gigapub">GigaPub</option></select><input id="s1-id" placeholder="Zone ID"></div></div>
                <div class="form-group" style="background:#f9fafb; padding:15px; border-radius:8px;"><label style="color:var(--primary); margin-bottom:10px;">Ad Slot 2</label><div class="form-row"><select id="s2-net"><option value="monetag">Monetag</option><option value="gigapub">GigaPub</option></select><input id="s2-id" placeholder="Zone ID"></div></div>
                <div class="form-row"><div class="form-group"><label>Reward Per Ad</label><input type="number" id="ad-reward"></div><div class="form-group"><label>Daily Limit</label><input type="number" id="ad-limit"></div></div>
                <button class="btn btn-p" onclick="saveAds()">Save Settings</button>
            </div>
        </div>

        <!-- WITHDRAWALS -->
        <div id="withdraw" class="page">
            <div class="card">
                <div class="card-head"><span class="card-title">Pending Requests</span></div>
                <div class="table-container"><table id="pending-table"><thead><tr><th>User</th><th>Details</th><th>Amount</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <!-- SETTINGS -->
        <div id="settings" class="page">
            <div class="card">
                <div class="card-head"><span class="card-title">General Settings</span></div>
                <div class="form-row"><div class="form-group"><label>Currency Symbol</label><input id="curr-sym"></div><div class="form-group"><label>Bot Username</label><input id="bot-user"></div></div>
                <div class="form-row"><div class="form-group"><label>Referral Bonus</label><input type="number" id="ref-bonus"></div><div class="form-group"><label>Min Refs to Withdraw</label><input type="number" id="min-ref"></div></div>
                <div class="form-group"><label>Support Link</label><input id="supp-link"></div>
                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                <h4 style="margin-bottom:15px;">Payment Methods</h4><div id="method-list"></div><button class="btn btn-sm btn-w" onclick="addMethodUI()">+ Add Method</button>
                <div style="margin-top:30px;"><button class="btn btn-p" onclick="saveSettings()">Save All Changes</button></div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBjBjNF_ceN-E3H3m-JwGJd-8PfV8ei004",
            authDomain: "task2-47f7d.firebaseapp.com",
            databaseURL: "https://task2-47f7d-default-rtdb.firebaseio.com",
            projectId: "task2-47f7d",
            storageBucket: "task2-47f7d.firebasestorage.app",
            messagingSenderId: "729837266208",
            appId: "1:729837266208:web:c16aa9222254140bc36345"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let userList = [];

        window.onload = () => { loadStats(); loadUsers(); loadTasks(); loadAds(); loadWithdraws(); loadSettings(); };

        function nav(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            if(window.innerWidth <= 768) toggleMenu();
        }
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('show');
            document.querySelector('.overlay').classList.toggle('show');
        }

        // --- DASHBOARD ---
        function loadStats() {
            db.ref('withdrawals/pending').on('value', s => document.getElementById('stat-pending').innerText = s.numChildren());
            db.ref('withdrawals/completed').on('value', s => document.getElementById('stat-paid').innerText = s.numChildren());
        }

        // --- USERS ---
        function loadUsers() {
            db.ref('users').on('value', snap => {
                const tbody = document.querySelector('#user-table tbody'); tbody.innerHTML = '';
                userList = [];
                if(snap.exists()) userList = Object.values(snap.val());
                document.getElementById('stat-users').innerText = userList.length;
                renderUsers(userList);
            });
        }
        function renderUsers(list) {
            const tbody = document.querySelector('#user-table tbody'); tbody.innerHTML = '';
            if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No users found</td></tr>'; return; }
            list.forEach(u => {
                const status = u.isBanned ? '<span style="color:var(--danger); font-weight:700;">Banned</span>' : '<span style="color:var(--success);">Active</span>';
                const banBtn = u.isBanned ? `<button class="btn btn-sm btn-s" onclick="toggleBan('${u.id}', false)">Unban</button>` : `<button class="btn btn-sm btn-w" onclick="toggleBan('${u.id}', true)">Ban</button>`;
                tbody.innerHTML += `<tr><td><div class="user-cell"><img src="${u.photoUrl||'https://via.placeholder.com/40'}" class="user-img"><div><div style="font-weight:600;">${u.firstName}</div><div style="font-size:0.8rem; color:#6b7280;">ID: ${u.id}</div></div></div></td><td style="font-weight:600;">${(u.balance||0).toFixed(2)}</td><td>${u.referrals||0}</td><td>${status}</td><td><button class="btn btn-sm btn-p" onclick="editBal('${u.id}')"><i class="fas fa-coins"></i></button>${banBtn}<button class="btn btn-sm btn-d" onclick="deleteUser('${u.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }
        function filterUsers() {
            const term = document.getElementById('search-box').value.toLowerCase();
            renderUsers(userList.filter(u => (u.firstName && u.firstName.toLowerCase().includes(term)) || (u.id && u.id.toString().includes(term))));
        }
        function editBal(uid) {
            const amt = prompt("Enter amount (+/-):");
            if(amt) db.ref(`users/${uid}/balance`).set(firebase.database.ServerValue.increment(parseFloat(amt)));
        }
        function toggleBan(uid, status) { if(confirm(status?"Ban?":"Unban?")) db.ref(`users/${uid}/isBanned`).set(status); }
        function deleteUser(uid) { if(confirm("Delete permanently?")) db.ref(`users/${uid}`).remove(); }

        // --- TASKS ---
        function loadTasks() {
            db.ref('config/webTasks').on('value', s => {
                const tbody = document.querySelector('#task-table tbody'); tbody.innerHTML = '';
                if(s.exists()) {
                    s.forEach(c => {
                        const t = c.val(); const dataStr = encodeURIComponent(JSON.stringify(t));
                        tbody.innerHTML += `<tr><td><img src="${t.icon}" width="30"></td><td>${t.name}</td><td>${t.reward}</td><td>${t.type}</td><td><button class="btn btn-sm btn-w" onclick="editTask('${c.key}', '${dataStr}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-d" onclick="delTask('${c.key}')"><i class="fas fa-trash"></i></button></td></tr>`;
                    });
                } else { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No Tasks</td></tr>'; }
            });
        }
        function saveTask() {
            const d = { name: document.getElementById('t-name').value, reward: parseFloat(document.getElementById('t-reward').value), url: document.getElementById('t-url').value, icon: document.getElementById('t-icon').value, type: document.getElementById('t-type').value };
            const k = document.getElementById('edit-key').value;
            if(!d.name || !d.url) return alert("Fill required fields");
            if(k) db.ref(`config/webTasks/${k}`).update(d).then(()=>{ alert("Updated"); cancelEdit(); });
            else db.ref('config/webTasks').push(d).then(()=>{ alert("Added"); cancelEdit(); });
        }
        function editTask(key, data) {
            const t = JSON.parse(decodeURIComponent(data));
            document.getElementById('edit-key').value = key; document.getElementById('t-name').value = t.name; document.getElementById('t-reward').value = t.reward; document.getElementById('t-url').value = t.url; document.getElementById('t-icon').value = t.icon; document.getElementById('t-type').value = t.type;
            document.getElementById('task-card-title').innerText = "Edit Task"; document.getElementById('btn-save-task').innerText = "Update"; document.getElementById('btn-cancel-task').style.display = "inline-block";
            document.getElementById('tasks').scrollIntoView({behavior:'smooth'});
        }
        function cancelEdit() {
            document.getElementById('edit-key').value = ''; document.getElementById('t-name').value = ''; document.getElementById('t-reward').value = ''; document.getElementById('t-url').value = ''; document.getElementById('t-icon').value = '';
            document.getElementById('task-card-title').innerText = "Add Task"; document.getElementById('btn-save-task').innerText = "Add Task"; document.getElementById('btn-cancel-task').style.display = "none";
        }
        function delTask(k) { if(confirm("Delete?")) db.ref(`config/webTasks/${k}`).remove(); }

        // --- ADS ---
        function loadAds() {
            db.ref('config').once('value', s => {
                const c = s.val() || {}; const l = c.adSlots||[];
                if(l[0]) { document.getElementById('s1-net').value=l[0].network; document.getElementById('s1-id').value=l[0].id; }
                if(l[1]) { document.getElementById('s2-net').value=l[1].network; document.getElementById('s2-id').value=l[1].id; }
                document.getElementById('ad-reward').value = c.adReward||0; document.getElementById('ad-limit').value = c.dailyAdLimit||0;
            });
        }
        function saveAds() {
            const slots = [{ network: document.getElementById('s1-net').value, id: document.getElementById('s1-id').value }, { network: document.getElementById('s2-net').value, id: document.getElementById('s2-id').value }];
            db.ref('config').update({ adSlots: slots, adReward: parseFloat(document.getElementById('ad-reward').value), dailyAdLimit: parseInt(document.getElementById('ad-limit').value) }).then(()=>alert("Saved"));
        }

        // --- WITHDRAWALS (FIXED PRESERVING DATA) ---
        function loadWithdraws() {
            db.ref('withdrawals/pending').on('value', s => {
                const tb = document.querySelector('#pending-table tbody'); tb.innerHTML='';
                if(s.exists()) {
                    s.forEach(c => {
                        const r = c.val();
                        tb.innerHTML += `<tr><td><b>${r.userName}</b><br><small>${r.userId}</small></td><td>${r.method}<br><small>${r.account}</small></td><td style="color:var(--danger); font-weight:bold;">${r.amount}</td><td><button class="btn btn-sm btn-s" onclick="pay('${c.key}',1)"><i class="fas fa-check"></i></button><button class="btn btn-sm btn-d" onclick="pay('${c.key}',0)"><i class="fas fa-times"></i></button></td></tr>`;
                    });
                } else { tb.innerHTML='<tr><td colspan="4" style="text-align:center;">No Pending Requests</td></tr>'; }
            });
        }
        async function pay(k, ok) {
            const s = await db.ref(`withdrawals/pending/${k}`).once('value');
            const v = s.val();
            if(ok) {
                // Keep ALL data (userId, userName, method, etc.)
                await db.ref(`withdrawals/completed/${k}`).set({...v, status:'completed', timestamp:Date.now()});
            } else {
                await db.ref(`users/${v.userId}/balance`).set(firebase.database.ServerValue.increment(v.amount));
                await db.ref(`withdrawals/rejected/${k}`).set({...v, status:'rejected', timestamp:Date.now()});
            }
            db.ref(`withdrawals/pending/${k}`).remove();
        }

        // --- SETTINGS ---
        function loadSettings() {
            db.ref('config').on('value', s => {
                const c = s.val() || {};
                document.getElementById('curr-sym').value = c.currencySymbol || 'TK';
                document.getElementById('bot-user').value = c.botUsername || '';
                document.getElementById('ref-bonus').value = c.referralBonus || 0;
                document.getElementById('min-ref').value = c.minWithdrawReferrals || 0;
                document.getElementById('supp-link').value = c.supportLink || '';
                const mBox = document.getElementById('method-list'); mBox.innerHTML = '';
                (c.withdrawMethods||[]).forEach(m => addMethodUI(m.name, m.min));
            });
        }
        function saveSettings() {
            const ms = [];
            document.querySelectorAll('#method-list div').forEach(d => {
                const n = d.querySelector('.m-name').value; const m = d.querySelector('.m-min').value;
                if(n && m) ms.push({name:n, min:parseFloat(m)});
            });
            db.ref('config').update({ currencySymbol: document.getElementById('curr-sym').value, botUsername: document.getElementById('bot-user').value, referralBonus: parseFloat(document.getElementById('ref-bonus').value), minWithdrawReferrals: parseInt(document.getElementById('min-ref').value), supportLink: document.getElementById('supp-link').value, withdrawMethods: ms }).then(()=>alert("Saved"));
        }
        function addMethodUI(n='', m='') {
            const div = document.createElement('div'); div.style.cssText = "display:flex; gap:10px; margin-bottom:10px;";
            div.innerHTML = `<input class="m-name" value="${n}" placeholder="Method Name"><input class="m-min" type="number" value="${m}" placeholder="Min"><button class="btn btn-d" onclick="this.parentElement.remove()">X</button>`;
            document.getElementById('method-list').appendChild(div);
        }
    </script>
</body>
</html>